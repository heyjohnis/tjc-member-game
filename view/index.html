<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TJC Daebang Member Game</title>
    <style>
      @import url(http://fonts.googleapis.com/earlyaccess/nanumgothic.css);
      * {
        margin: 0;
        padding: 0;
      }
      body {
        background-color: #000;
        font-family: "Nanum Gothic", sans-serif;
        overflow: hidden;
      }
      .btn_start {
        position: absolute;
        top: 0;
        display: block;
        height: 100vh;
        width: 100%;
        font-size: 40px;
        border-radius: 0;
        border: 0;
        background-color: #000;
        color: #fff;
        font-size: 100px;
      }

      .monitor {
        display: flex;
        width: 340px;
        margin: 10px auto;
        color: #777;
      }
      .monitor div {
        text-align: left;
        font-size: 15px;
      }
      .monitor span {
        color: #ccc;
      }
      .time {
        width: 26%;
        text-align: left;
      }
      .time span {
        text-align: right;
        color: #ccc;
      }

      .score {
        width: 30%;
      }
      .correct {
        width: 30%;
      }
      .correct span {
        color: #ccc;
      }
      .level {
        width: 14%;
        text-align: right !important;
      }

      .picture {
        width: 320px;
        height: 170px;
        margin: 0 auto;
        border: 10px solid #000;
        background-color: #000;
      }
      .picture img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .input_name {
        display: block;
        margin: 10px auto;
        width: 340px;
        height: 70px;
        font-size: 40px;
        text-align: center;
        border: 0;
        background-color: #ccc;
      }
      .btn_hint {
        display: block;
        margin: 10px auto;
        width: 340px;
        height: 70px;
        font-size: 40px;
        text-align: center;
        background-color: #0a3c9f;
        color: #6f9eff;
        border: 0;
        cursor: pointer;
      }
      .hint {
        display: none;
        width: 340px;
        height: 70px;
        margin: 10px auto;
        font-size: 40px;
        text-align: center;
        align-items: center;
        justify-content: center;
        color: #fff;
      }
      .pass_quiz {
        display: block;
        margin: 10px auto;
        width: 340px;
        height: 70px;
        font-size: 40px;
        text-align: center;
        background-color: #750d0d;
        color: #ff5757;
        border: 0;
        cursor: pointer;
      }
      #hidden_input {
        width: 0px;
        height: 0px;
        border: 0;
      }

      #result_effect {
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        top: 0;
        left: 0;
        width: 100%;
        height: 170px;
        padding: 20px 0;
        text-align: center;
        z-index: 9999;
        font-size: 50px;
        opacity: 1;
        font-weight: bold;
        color: #ff8400;
        transition: all 1s cubic-bezier(0, 0, 0, 0.97);
      }

      .score_effect {
        opacity: 0;
        transform: scale(3);
      }
    </style>
  </head>
  <body>
    <input type="text" id="hidden_input" />
    <div id="result_effect"></div>
    <input
      type="button"
      id="btn_start"
      class="btn_start"
      value="시작"
      onclick="stratQuiz()"
    />
    <div id="picture" class="picture"></div>
    <input
      type="text"
      id="input_name"
      class="input_name"
      onkeyup="quizRequest(event)"
      style="ime-mode: active"
    />
    <div class="monitor">
      <div class="time">
        시간:
        <span id="time">0</span>
      </div>
      <div class="correct">맞춘 갯수: <span id="correct">0</span></div>
      <div class="score">점수: <span id="score">100</span></div>
      <div class="level">Lv: <span id="level">1</span></div>
    </div>
    <input
      type="button"
      id="btn_hint"
      class="btn_hint"
      value="힌트"
      onclick="handleHint()"
    />
    <div class="hint" id="hint"></div>

    <input type="button" value="통과" class="pass_quiz" onclick="passQuiz()" />
  </body>
  <script>
    const gameData = {
      picture: [],
      score: 100,
      level: 1,
      nextScore: 200,
      time: 0,
      correct: 0,
      thisPicture: null,
      startTime: 0,
      hintPenalty: 20,
      passPenalty: 50,
      minCnt: 40,
    };
    const $startButton = document.getElementById("btn_start");
    const $picture = document.getElementById("picture");
    const $hint = document.getElementById("hint");
    const $score = document.getElementById("score");
    const $time = document.getElementById("time");
    const $energy = document.getElementById("energy");
    const $level = document.getElementById("level");
    const $resultEffect = document.getElementById("result_effect");
    const $inputName = document.getElementById("input_name");
    const $hiddenInput = document.getElementById("hidden_input");

    getPictureData(gameData.minCnt);

    function getPictureData(cnt) {
      fetch(`/member/daebang/pic?cnt=${cnt}`)
        .then((res) => res.json())
        .then((res) => {
          gameData.picture = res;
          console.log("res", res);
        });
    }
    function stratQuiz() {
      setQuizPictureData();
      $startButton.style.display = "none";
      setIntervalTimer();
    }

    function quizRequest(e) {
      const value = e.target.value;
      if (value.length >= 2) {
        if (
          value === gameData.thisPicture.name ||
          value === gameData.thisPicture.nickname
        ) {
          correctQuiz();
          setQuizPictureData();
          clearInputName();
          clearHint();
        }
      }
    }

    function setQuizPictureData() {
      const items = gameData.picture;
      const item = items[Math.floor(Math.random() * items.length)];
      console.log(item);
      gameData.thisPicture = item;
      gameData.startTime = gameData.time;
      renderQuizPicture(item);
      clearHint();
    }

    function setScore() {
      const termTime = gameData.time - gameData.startTime;
      let scoreTime = 15 - gameData.level - termTime;
      scoreTime = scoreTime > -2 ? scoreTime : -2;
      gameData.score += scoreTime * 10;
      gameData.score = gameData.score > 0 ? gameData.score : 0;
      $score.innerHTML = gameData.score.toLocaleString();
      scoreEffect(scoreTime * 10);
      setLevel();
    }

    function renderQuizPicture(item) {
      $picture.innerHTML = `<img src="http://portal.tjc.or.kr/${item.photo}" />`;
    }

    function setIntervalTimer() {
      const $time = document.getElementById("time");
      const timer = setInterval(() => {
        gameData.time++;
        $time.innerHTML = gameData.time.toLocaleString();
      }, 1000);
    }

    function correctQuiz() {
      const $correct = document.getElementById("correct");
      gameData.correct++;
      $correct.innerHTML = gameData.correct;
      setScore();
    }

    function scoreEffect(score) {
      $resultEffect.style.opacity = 0;
      if (score > 0) {
        $resultEffect.style.color = "#5eed19";
        $resultEffect.innerHTML = `+${score}`;
      } else {
        $resultEffect.style.color = "#ff0000";
        $resultEffect.innerHTML = `${score}`;
      }
      $resultEffect.classList.add("score_effect");
      setTimeout(() => {
        $resultEffect.style.opacity = 1;
        $resultEffect.classList.remove("score_effect");
        $resultEffect.innerHTML = "";
      }, 1000);
    }

    function clearInputName() {
      $inputName.value = "";
      console.log("clearInputName", $inputName.value);
      $hiddenInput.focus();
      $inputName.focus();
    }

    function clearHint() {
      $hint.innerHTML = null;
      $hint.style.display = "none";
      const $btnHint = document.getElementById("btn_hint");
      $btnHint.style.display = "block";
    }

    function handleHint() {
      $hint.style.display = "flex";
      const $btnHint = document.getElementById("btn_hint");
      $btnHint.style.display = "none";
      setPenaltyScore(gameData.hintPenalty);
      $hint.innerHTML = `○ ${gameData.thisPicture.name.substring(1, 2)} ○`;
      setLevel();
      $inputName.focus();
    }

    function setLevel() {
      const floor = Math.floor(gameData.score / gameData.nextScore);
      const level = floor > 1 ? floor : 1;
      if (gameData.level !== level) {
        gameData.level = level;
        const cnt =
          gameData.minCnt - level * 5 > 0 ? gameData.minCnt - level * 5 : 0;
        getPictureData(cnt);
      }
      $level.innerHTML = level;
    }

    function setPenaltyScore(score) {
      scoreEffect(score * -1);
      const calcScore = (gameData.score -= score);
      gameData.score = calcScore > 0 ? calcScore : 0;
      $score.innerHTML = gameData.score.toLocaleString();
    }

    function passQuiz() {
      const $input_name = document.getElementById("input_name");
      $input_name.value = gameData.thisPicture.name;
      setPenaltyScore(gameData.passPenalty);
      setLevel();
      setTimeout(() => {
        clearInputName();
        setQuizPictureData();
        clearHint();
        $inputName.focus();
      }, 8000);
    }
  </script>
</html>
